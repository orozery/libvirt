From 6ea3bb19c6fed39429c95eb284487b849cb12e2a Mon Sep 17 00:00:00 2001
From: Jiri Denemark <jdenemar@redhat.com>
Date: Wed, 17 Jun 2020 14:08:43 +0200
Subject: [PATCH] cpu_map: Add missing x86 features in 0x7 CPUID leaf
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Jiri Denemark <jdenemar@redhat.com>
Reviewed-by: Daniel P. Berrang√© <berrange@redhat.com>

Origin: backport, https://libvirt.org/git/?p=libvirt.git;a=commit;h=6ea3bb19
Bug-Ubuntu: https://bugs.launchpad.net/bugs/1887490
Last-Update: 2020-10-14
X-Backport-Note:
  - qemu 5.1 didn't exist yet, skipped those hunks

---
 src/cpu_map/x86_features.xml                         | 12 ++++++++++++
 .../x86_64-cpuid-Ice-Lake-Server-disabled.xml        |  2 +-
 .../x86_64-cpuid-Ice-Lake-Server-guest.xml           |  1 +
 .../x86_64-cpuid-Ice-Lake-Server-host.xml            |  1 +
 .../x86_64-cpuid-Ryzen-9-3900X-12-Core-enabled.xml   |  2 +-
 .../x86_64-cpuid-Ryzen-9-3900X-12-Core-guest.xml     |  1 +
 .../x86_64-cpuid-Ryzen-9-3900X-12-Core-host.xml      |  1 +
 .../x86_64-cpuid-Ryzen-9-3900X-12-Core-json.xml      |  1 +
 tests/domaincapsdata/qemu_5.1.0-q35.x86_64.xml       |  1 +
 tests/domaincapsdata/qemu_5.1.0.x86_64.xml           |  1 +
 10 files changed, 21 insertions(+), 2 deletions(-)

--- a/src/cpu_map/x86_features.xml
+++ b/src/cpu_map/x86_features.xml
@@ -293,6 +293,9 @@
   <feature name='ospke'>
     <cpuid eax_in='0x07' ecx_in='0x00' ecx='0x00000010'/>
   </feature>
+  <feature name='waitpkg'>
+    <cpuid eax_in='0x07' ecx_in='0x00' ecx='0x00000020'/>
+  </feature>
   <feature name='avx512vbmi2'>
     <cpuid eax_in='0x07' ecx_in='0x00' ecx='0x00000040'/>
   </feature>
@@ -317,9 +320,18 @@
   <feature name='la57'>
     <cpuid eax_in='0x07' ecx_in='0x00' ecx='0x00010000'/>
   </feature>
+  <feature name='rdpid'>
+    <cpuid eax_in='0x07' ecx_in='0x00' ecx='0x00400000'/>
+  </feature>
   <feature name='cldemote'>
     <cpuid eax_in='0x07' ecx_in='0x00' ecx='0x02000000'/>
   </feature>
+  <feature name='movdiri'>
+    <cpuid eax_in='0x07' ecx_in='0x00' ecx='0x08000000'/>
+  </feature>
+  <feature name='movdir64b'>
+    <cpuid eax_in='0x07' ecx_in='0x00' ecx='0x10000000'/>
+  </feature>
 
   <feature name='avx512-4vnniw'>
     <cpuid eax_in='0x07' ecx_in='0x00' edx='0x00000004'/>
--- a/tests/cputestdata/x86_64-cpuid-Ice-Lake-Server-disabled.xml
+++ b/tests/cputestdata/x86_64-cpuid-Ice-Lake-Server-disabled.xml
@@ -1,7 +1,7 @@
 <!-- Features disabled by QEMU -->
 <cpudata arch='x86'>
   <cpuid eax_in='0x00000001' ecx_in='0x00' eax='0x00000000' ebx='0x00000000' ecx='0x0804c1fc' edx='0xb0600000'/>
-  <cpuid eax_in='0x00000007' ecx_in='0x00' eax='0x00000000' ebx='0x02001000' ecx='0x00000010' edx='0x00000000'/>
+  <cpuid eax_in='0x00000007' ecx_in='0x00' eax='0x00000000' ebx='0x02001000' ecx='0x00400010' edx='0x00000000'/>
   <cpuid eax_in='0x0000000f' ecx_in='0x01' eax='0x00000000' ebx='0x00000000' ecx='0x00000000' edx='0x00000006'/>
   <cpuid eax_in='0x80000007' ecx_in='0x00' eax='0x00000000' ebx='0x00000000' ecx='0x00000000' edx='0x00000100'/>
 </cpudata>
--- a/tests/cputestdata/x86_64-cpuid-Ice-Lake-Server-guest.xml
+++ b/tests/cputestdata/x86_64-cpuid-Ice-Lake-Server-guest.xml
@@ -23,6 +23,7 @@
   <feature policy='require' name='avx512ifma'/>
   <feature policy='require' name='sha-ni'/>
   <feature policy='require' name='ospke'/>
+  <feature policy='require' name='rdpid'/>
   <feature policy='require' name='stibp'/>
   <feature policy='require' name='arch-capabilities'/>
   <feature policy='require' name='xsaves'/>
--- a/tests/cputestdata/x86_64-cpuid-Ice-Lake-Server-host.xml
+++ b/tests/cputestdata/x86_64-cpuid-Ice-Lake-Server-host.xml
@@ -24,6 +24,7 @@
   <feature name='avx512ifma'/>
   <feature name='sha-ni'/>
   <feature name='ospke'/>
+  <feature name='rdpid'/>
   <feature name='stibp'/>
   <feature name='arch-capabilities'/>
   <feature name='xsaves'/>
--- a/tests/cputestdata/x86_64-cpuid-Ryzen-9-3900X-12-Core-enabled.xml
+++ b/tests/cputestdata/x86_64-cpuid-Ryzen-9-3900X-12-Core-enabled.xml
@@ -2,7 +2,7 @@
 <cpudata arch='x86'>
   <cpuid eax_in='0x00000001' ecx_in='0x00' eax='0x00000000' ebx='0x00000000' ecx='0xf7f83203' edx='0x078bfbff'/>
   <cpuid eax_in='0x00000006' ecx_in='0x00' eax='0x00000004' ebx='0x00000000' ecx='0x00000000' edx='0x00000000'/>
-  <cpuid eax_in='0x00000007' ecx_in='0x00' eax='0x00000000' ebx='0x219c01ab' ecx='0x00000004' edx='0xa8000000'/>
+  <cpuid eax_in='0x00000007' ecx_in='0x00' eax='0x00000000' ebx='0x219c01ab' ecx='0x00400004' edx='0xa8000000'/>
   <cpuid eax_in='0x0000000d' ecx_in='0x01' eax='0x0000000f' ebx='0x00000000' ecx='0x00000000' edx='0x00000000'/>
   <cpuid eax_in='0x80000001' ecx_in='0x00' eax='0x00000000' ebx='0x00000000' ecx='0x008003f7' edx='0x2e500800'/>
   <cpuid eax_in='0x80000008' ecx_in='0x00' eax='0x00000000' ebx='0x03001201' ecx='0x00000000' edx='0x00000000'/>
--- a/tests/cputestdata/x86_64-cpuid-Ryzen-9-3900X-12-Core-guest.xml
+++ b/tests/cputestdata/x86_64-cpuid-Ryzen-9-3900X-12-Core-guest.xml
@@ -6,6 +6,7 @@
   <feature policy='require' name='cmt'/>
   <feature policy='require' name='clwb'/>
   <feature policy='require' name='umip'/>
+  <feature policy='require' name='rdpid'/>
   <feature policy='require' name='xsaves'/>
   <feature policy='require' name='mbm_total'/>
   <feature policy='require' name='mbm_local'/>
--- a/tests/cputestdata/x86_64-cpuid-Ryzen-9-3900X-12-Core-host.xml
+++ b/tests/cputestdata/x86_64-cpuid-Ryzen-9-3900X-12-Core-host.xml
@@ -7,6 +7,7 @@
   <feature name='cmt'/>
   <feature name='clwb'/>
   <feature name='umip'/>
+  <feature name='rdpid'/>
   <feature name='xsaves'/>
   <feature name='mbm_total'/>
   <feature name='mbm_local'/>
--- a/tests/cputestdata/x86_64-cpuid-Ryzen-9-3900X-12-Core-json.xml
+++ b/tests/cputestdata/x86_64-cpuid-Ryzen-9-3900X-12-Core-json.xml
@@ -7,6 +7,7 @@
   <feature policy='require' name='tsc_adjust'/>
   <feature policy='require' name='clwb'/>
   <feature policy='require' name='umip'/>
+  <feature policy='require' name='rdpid'/>
   <feature policy='require' name='stibp'/>
   <feature policy='require' name='arch-capabilities'/>
   <feature policy='require' name='ssbd'/>
